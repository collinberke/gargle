<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Intended primarily for internal use in client packages that provide
high-level wrappers for users. It is a drop-in substitute for
request_make() that also has the ability to retry the request. Codes that
are considered retryable: 408, 429, 500, 502, 503."><title>Make a Google API request, repeatedly — request_retry • gargle</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.7/font.css" rel="stylesheet"><link href="../deps/Source_Code_Pro-0.4.7/font.css" rel="stylesheet"><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Make a Google API request, repeatedly — request_retry"><meta property="og:description" content="Intended primarily for internal use in client packages that provide
high-level wrappers for users. It is a drop-in substitute for
request_make() that also has the ability to retry the request. Codes that
are considered retryable: 408, 429, 500, 502, 503."><meta name="robots" content="noindex"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="gargle.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script></head><body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">gargle</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.5.1.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/non-interactive-auth.html">Non-interactive auth</a>
    <a class="dropdown-item" href="../articles/troubleshooting.html">Troubleshooting gargle auth</a>
    <a class="dropdown-item" href="../articles/auth-from-web.html">Auth when using R from the browser</a>
    <a class="dropdown-item" href="../articles/get-api-credentials.html">How to get your own API credentials</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-news">News</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-news">
    <h6 class="dropdown-header" data-toc-skip>Releases</h6>
    <a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/07/gargle-1-2-0/">gargle 1.2.0</a>
    <a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/08/gargle-hello-world/">gargle's debut on CRAN</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../news/index.html">Changelog</a>
  </div>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/gargle/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Make a Google API request, repeatedly</h1>
      <small class="dont-index">Source: <a href="https://github.com/r-lib/gargle/blob/HEAD/R/request_retry.R" class="external-link"><code>R/request_retry.R</code></a></small>
      <div class="d-none name"><code>request_retry.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Intended primarily for internal use in client packages that provide
high-level wrappers for users. It is a drop-in substitute for
<code><a href="request_make.html">request_make()</a></code> that also has the ability to retry the request. Codes that
are considered retryable: 408, 429, 500, 502, 503.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">request_retry</span><span class="op">(</span><span class="va">...</span>, max_tries_total <span class="op">=</span> <span class="fl">5</span>, max_total_wait_time_in_seconds <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>...</dt>
<dd><p>Passed along to <code><a href="request_make.html">request_make()</a></code>.</p></dd>


<dt>max_tries_total</dt>
<dd><p>Maximum number of tries.</p></dd>


<dt>max_total_wait_time_in_seconds</dt>
<dd><p>Total seconds we are willing to
dedicate to waiting, summed across all tries. This is a technical upper
bound and actual cumulative waiting will be less.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>Object of class <code>response</code> from httr.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Consider an example where we are willing to make a request up to 5 times.</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>try  <span class="dv">1</span>  <span class="dv">2</span>    <span class="dv">3</span>        <span class="dv">4</span>                <span class="dv">5</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>     <span class="sc">|--</span><span class="er">|</span><span class="sc">----</span><span class="er">|</span><span class="sc">--------</span><span class="er">|</span><span class="sc">----------------</span><span class="er">|</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>wait  <span class="dv">1</span>   <span class="dv">2</span>      <span class="dv">3</span>           <span class="dv">4</span></span></code></pre><p></p></div>
<p>There will be up to 5 - 1 = 4 waits and we generally want the waiting period
to get longer, in an exponential way. Such schemes are called exponential
backoff. <code>request_retry()</code> implements exponential backoff with "full jitter",
where each waiting time is generated from a uniform distribution, where the
interval of support grows exponentially. A common alternative is "equal
jitter", which adds some noise to fixed, exponentially increasing waiting
times.</p>
<p>Either way our waiting times are based on a geometric series, which, by
convention, is usually written in terms of powers of 2:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>b, 2b, 4b, 8b, ...</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> b <span class="sc">*</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">0</span>, b <span class="sc">*</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">1</span>, b <span class="sc">*</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">2</span>, b <span class="sc">*</span> <span class="dv">2</span><span class="sc">^</span><span class="dv">3</span>, ...</span></code></pre><p></p></div>
<p>The terms in this series require knowledge of <code>b</code>, the so-called exponential
base, and many retry functions and libraries require the user to specify
this. But most users find it easier to declare the total amount of waiting
time they can tolerate for one request. Therefore <code>request_retry()</code> asks for
that instead and solves for <code>b</code> internally. This is inspired by the Opnieuw
Python library for retries. Opnieuw's interface is designed to eliminate
uncertainty around:</p><ul><li><p>Units: Is this thing given in seconds? minutes? milliseconds?</p></li>
<li><p>Ambiguity around how things are counted: Are we starting at 0 or 1?
Are we counting tries or just the retries?</p></li>
<li><p>Non-intuitive required inputs, e.g., the exponential base.</p></li>
</ul><p>Let <em>n</em> be the total number of tries we're willing to make (the argument
<code>max_tries_total</code>) and let <em>W</em> be the total amount of seconds we're willing
to dedicate to making and retrying this request (the argument
<code>max_total_wait_time_in_seconds</code>). Here's how we determine <em>b</em>:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>sum_{i<span class="ot">=</span><span class="dv">0</span>}<span class="sc">^</span>(n <span class="sc">-</span> <span class="dv">1</span>) b <span class="sc">*</span> <span class="dv">2</span><span class="sc">^</span>i <span class="ot">=</span> W</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>b <span class="sc">*</span> sum_{i<span class="ot">=</span><span class="dv">0</span>}<span class="sc">^</span>(n <span class="sc">-</span> <span class="dv">1</span>) <span class="dv">2</span><span class="sc">^</span>i <span class="ot">=</span> W</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>       b <span class="sc">*</span> ( (<span class="dv">2</span> <span class="sc">^</span> n) <span class="sc">-</span> <span class="dv">1</span>) <span class="ot">=</span> W</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                        b <span class="ot">=</span> W <span class="sc">/</span> ( (<span class="dv">2</span> <span class="sc">^</span> n) <span class="sc">-</span> <span class="dv">1</span>)</span></code></pre><p></p></div>
    </div>
    <div class="section level2">
    <h2 id="special-cases">Special cases<a class="anchor" aria-label="anchor" href="#special-cases"></a></h2>
    

<p><code>request_retry()</code> departs from exponential backoff in three special cases:</p><ul><li><p>It actually implements <em>truncated</em> exponential backoff. There is a floor
and a ceiling on random wait times.</p></li>
<li><p><code>Retry-After</code> header: If the response has a header named <code>Retry-After</code>
(case-insensitive), it is assumed to provide a non-negative integer
indicating the number of seconds to wait. If present, we wait this many
seconds and do not generate a random waiting time. (In theory, this header
can alternatively provide a datetime after which to retry, but we have no
first-hand experience with this variant for a Google API.)</p></li>
<li><p>Sheets API quota exhaustion: In the course of googlesheets4 development,
we've grown very familiar with the <code>429 RESOURCE_EXHAUSTED</code> error. As of
2023-04-15, the Sheets API v4 has a limit of 300 requests per minute per
project and 60 requests per minute per user per project. Limits for reads
and writes are tracked separately. In our experience, the "60 (read or
write) requests per minute per user" limit is the one you hit most often.
If we detect this specific failure, the first wait time is a bit more than
one minute, then we revert to exponential backoff.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index">
<ul><li><p><a href="https://aws.amazon.com/blogs/architecture/exponential-backoff-and-jitter/" class="external-link">https://aws.amazon.com/blogs/architecture/exponential-backoff-and-jitter/</a></p></li>
<li><p><a href="https://tech.channable.com/posts/2020-02-05-opnieuw.html" class="external-link">https://tech.channable.com/posts/2020-02-05-opnieuw.html</a></p></li>
<li><p><a href="https://github.com/channable/opnieuw" class="external-link">https://github.com/channable/opnieuw</a></p></li>
<li><p><a href="https://cloud.google.com/storage/docs/retry-strategy" class="external-link">https://cloud.google.com/storage/docs/retry-strategy</a></p></li>
<li><p><a href="https://www.rfc-editor.org/rfc/rfc7231#section-7.1.3" class="external-link">https://www.rfc-editor.org/rfc/rfc7231#section-7.1.3</a></p></li>
<li><p><a href="https://developers.google.com/sheets/api/limits" class="external-link">https://developers.google.com/sheets/api/limits</a></p></li>
<li><p><a href="https://googleapis.dev/python/google-api-core/latest/retry.html" class="external-link">https://googleapis.dev/python/google-api-core/latest/retry.html</a></p></li>
</ul></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="va">req</span> <span class="op">&lt;-</span> <span class="fu">gargle</span><span class="fu">::</span><span class="fu"><a href="request_develop.html">request_build</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  method <span class="op">=</span> <span class="st">"GET"</span>,</span></span>
<span class="r-in"><span>  path <span class="op">=</span> <span class="st">"path/to/the/resource"</span>,</span></span>
<span class="r-in"><span>  token <span class="op">=</span> <span class="st">"PRETEND_I_AM_TOKEN"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">gargle</span><span class="fu">::</span><span class="fu">request_retry</span><span class="op">(</span><span class="va">req</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p><p>Developed by <a href="https://jennybryan.org" class="external-link">Jennifer Bryan</a>, Craig Citro, <a href="http://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

  </div></footer></body></html>

